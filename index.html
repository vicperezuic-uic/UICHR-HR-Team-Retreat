<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>UIC Song Quiz</title>
<style>
body { font-family: 'Segoe UI', sans-serif; background:#f4f6f9; margin:0; padding:20px; }
img { width:150px; position:absolute; top:20px; left:20px; }
.quiz-container { max-width:900px; margin:0 auto; background:white; padding:20px; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
.question { margin-bottom:20px; }
input[type=text] { width:100%; padding:8px; margin:5px 0; border-radius:6px; border:1px solid #ccc; }
label { display:block; margin:4px 0; }
button { background:#d50032; color:white; border:none; padding:12px 20px; border-radius:8px; cursor:pointer; font-size:16px; }
button:hover { background:#a00025; }
</style>
</head>
<body>
<img src="uic_logo.jpg" alt="UIC Logo">
<div class="quiz-container">
  <h1>UIC Song Quiz</h1>
  <form id="quizForm"></form>
  <button id="submitBtn" type="button">Submit Quiz</button>
</div>

<!-- Load questions -->
<script src="questions.js"></script>

<script>
const currentUser = localStorage.getItem("currentUser");
if (!currentUser) {
  alert("Please enter your email first.");
  window.location.href = "start.html";
}

// Populate quiz dynamically
window.onload = function() {
  const form = document.getElementById("quizForm");
  questions.forEach((q,i) => {
    const div = document.createElement("div");
    div.className = "question";
    div.innerHTML = `
      <h3>Q${i+1}: Song Name</h3>
      <input type="text" id="song-${i}" maxlength="250" placeholder="Enter song name">
      <h4>Requested By:</h4>
      ${q.choices.map(c => `<label><input type="radio" name="requester-${i}" value="${c}"> ${c}</label>`).join('')}
    `;
    form.appendChild(div);
  });
}

// Normalize string for comparison
function normalize(str) {
  return str.toLowerCase().replace(/[^a-z0-9\s]/gi,"").replace(/\s+/g," ").trim();
}

// Submit quiz
document.getElementById("submitBtn").addEventListener("click", async function() {
  const submissions = JSON.parse(localStorage.getItem("quizSubmissions") || "{}");
  if (submissions[currentUser]) {
    alert("You have already submitted.");
    return;
  }

  let score = 0;
  const userAnswers = [];
  questions.forEach((q, i) => {
    const songAnswer = document.getElementById(`song-${i}`).value.trim();
    let requesterAnswer = "";
    document.getElementsByName(`requester-${i}`).forEach(r => { if(r.checked) requesterAnswer = r.value; });
    userAnswers.push({ songAnswer, requesterAnswer });
    if (normalize(songAnswer) === normalize(q.correctSong)) score += 1;
    if (requesterAnswer === q.correctRequester) score += 1;
  });

  submissions[currentUser] = { score, submittedAt: new Date().toISOString(), answers: userAnswers };
  localStorage.setItem("quizSubmissions", JSON.stringify(submissions));

  // Submit to Google Apps Script
  try {
    const response = await fetch(
      "https://script.google.com/macros/s/AKfycbxEX2GENHarqlBBR3OT8O7D6A4t-jAArcZAKyUd-VIuIspBuTc2tJtlpOxveCGjLlQU/exec",
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email: currentUser, score: score, answers: userAnswers }),
      }
    );

    const text = await response.text(); // get raw text
    let result;
    try {
      result = JSON.parse(text);
    } catch (jsonErr) {
      console.error("Failed to parse JSON from server:", text);
      alert("Error submitting quiz. Server returned unexpected response.");
      return;
    }

    if (result.result === "duplicate") {
      alert("This email has already submitted.");
      return;
    }

    if (result.result === "success") {
      alert(`Submission successful! You scored ${score} points.`);
      localStorage.removeItem("currentUser");
      window.location.href = "start.html";
    } else {
      console.error("Server returned error:", result);
      alert("Error submitting quiz. Please try again later.");
    }

  } catch (err) {
    console.error("Network or submission error:", err);
    alert("Error submitting quiz. Please check your internet connection or try again later.");
  }
});
</script>

</body>
</html>
