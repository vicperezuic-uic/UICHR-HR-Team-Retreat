document.getElementById("submitBtn").addEventListener("click", async function() {
  const submissions = JSON.parse(localStorage.getItem("quizSubmissions") || "{}");
  if (submissions[currentUser]) {
    alert("You have already submitted.");
    return;
  }

  let score = 0;
  const userAnswers = [];
  questions.forEach((q, i) => {
    const songAnswer = document.getElementById(`song-${i}`).value.trim();
    let requesterAnswer = "";
    document.getElementsByName(`requester-${i}`).forEach(r => {
      if (r.checked) requesterAnswer = r.value;
    });
    userAnswers.push({ songAnswer, requesterAnswer });
    if (normalize(songAnswer) === normalize(q.correctSong)) score += 1;
    if (requesterAnswer === q.correctRequester) score += 1;
  });

  submissions[currentUser] = { score, submittedAt: new Date().toISOString(), answers: userAnswers };
  localStorage.setItem("quizSubmissions", JSON.stringify(submissions));

  // Submit to Google Apps Script
  try {
    const response = await fetch(
      "https://script.google.com/macros/s/AKfycbxEX2GENHarqlBBR3OT8O7D6A4t-jAArcZAKyUd-VIuIspBuTc2tJtlpOxveCGjLlQU/exec",
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email: currentUser, score: score, answers: userAnswers }),
      }
    );

    const text = await response.text(); // get raw text
    let result;
    try {
      result = JSON.parse(text); // try parsing JSON
    } catch (jsonErr) {
      console.error("Failed to parse JSON from server:", text);
      alert("Error submitting quiz. Server returned unexpected response.");
      return;
    }

    if (result.result === "duplicate") {
      alert("This email has already submitted.");
      return;
    }

    alert(`Submission successful! You scored ${score} points.`);
    localStorage.removeItem("currentUser");
    window.location.href = "start.html";

  } catch (err) {
    console.error("Network or submission error:", err);
    alert("Error submitting quiz. Please check your internet connection or try again later.");
  }
});
